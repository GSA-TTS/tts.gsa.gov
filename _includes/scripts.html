{%comment%}Pull in custom js{%endcomment%}
<script async src="{{ assetPaths['app.js'] }}"></script>

<!-- Digital Analytics Program roll-up, see https://analytics.usa.gov for data -->
{% if site.dap.agency %}
<script
  id="_fed_an_ua_tag"
  src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency={{site.dap.agency}}{% if site.dap.subagency %}&subagency={{site.dap.subagency}}{% endif %}&pga4={{ site.ga }}"
></script>
{% endif %}

{% if site.searchgov %}
  {% if site.searchgov.suggestions == true %}
    <script>
          var usasearch_config = { siteHandle: "{{ site.searchgov.affiliate }}" };
    </script>
    <script async src="https://search.usa.gov/javascripts/remote.loader.js" type="text/javascript"></script>
  {% endif %}
{% endif %}

<!-- Custom subnav toggle -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const toggle = document.querySelector('.usa-subnav-mobile-toggle');
      if (toggle) {
          toggle.addEventListener('click', function() {
              toggle.classList.toggle('open-subnav');
          });
      }

      if (window.innerWidth < 1024) {
          const sidenavItems = document.querySelectorAll('li.usa-sidenav__item');
          sidenavItems.forEach(function(item) {
              if (item.querySelector('ul')) {
                  item.classList.add('toggle-submenu');
              }
          });
      }

      const subtoggle = document.querySelectorAll('.toggle-submenu');
      subtoggle.forEach(function(toggle) {
          toggle.addEventListener('click', function() {
              toggle.classList.toggle('open-subnav');
          });
      });
  });
</script>

<!-- Conditionally hide past info sessions -->
<script>
  const now = new Date();
  const currentTimestamp = Math.floor(new Date(now).getTime() / 1000);

  function formatDate(date) {
    const year = date.getFullYear(); // Get the four-digit year
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Get the month (0-11) and add 1; pad with 0 if needed
    const day = String(date.getDate()).padStart(2, '0'); // Get the day of the month; pad with 0 if needed

    return `${year}-${month}-${day}`; // Format as 'yyyy-mm-dd'
  }

  const path = window.location.pathname;
  const pathSegments = path.split('/');
  const lastPathItem = pathSegments[pathSegments.length - 1];

  console.log(lastPathItem);

  if ( lastPathItem === '/join/' ) {
    console.log(true)
    const allJobs = [];
      {% for job in collections.jobs %}
        allJobs.push({
          title: "{{ job.data.title }}",
          url: "{{ job.url }}",
          external_url: "{{ pg.data.external_url }}",
          opens: "{{ job.data.opens }}",
          closes: "{{ job.data.closes }}"
        });
      {% endfor %}

    sortJobs(allJobs);
    
  }

  console.log(allJobs);

  function sortJobs(allJobs) {
      const openJobs = [];
      const upcomingJobs = [];
      const today = formatDate(now);
      
      allJobs.forEach(job => {
        console.log(job)
        const opens = job.opens !== '' ? job.opens : '';

        const closes = job.closes !== ''  ? job.closes : '';

        //console.log(closes);

        // If today is after or equal to the opens date and before the closes date, add the job to the openJobs array.
        if ( today >= opens && closes > today ) {
          openJobs.push(job);
        }
      });

      console.log(openJobs)
  }

  function hidePastInfoSessions(currentTimestamp) {
    const infoSessionsGroup = document.querySelectorAll(".info-sessions-list");

    infoSessionsGroup.forEach(sessionGroup => {
      let visibleSessions = 0;

      // Convert sessionGroup.children to an array and loop over them
      Array.from(sessionGroup.children).forEach(session => {
        const session_timestamp = session.getAttribute('data-session-end-timestamp');

        console.log(currentTimestamp);

        // Hide past sessions
        if (session_timestamp < currentTimestamp) {
          session.style.display = 'none'; // Hide past session
        } else {
          visibleSessions++; // Count future session
        }
      });

      if (visibleSessions === 0) {
        const asideParent = sessionGroup.closest('aside');
        if (asideParent) {
          asideParent.style.display = 'none';
        }
      }
    });
  }
  hidePastInfoSessions(currentTimestamp);
</script>
