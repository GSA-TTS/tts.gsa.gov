{%comment%}Pull in custom js{%endcomment%}
<script async src="{{ assetPaths['app.js'] }}"></script>

<!-- Digital Analytics Program roll-up, see https://analytics.usa.gov for data -->
{% if site.dap.agency %}
<script
  id="_fed_an_ua_tag"
  src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency={{site.dap.agency}}{% if site.dap.subagency %}&subagency={{site.dap.subagency}}{% endif %}&pga4={{ site.ga }}"
></script>
{% endif %}

{% if site.searchgov %}
  {% if site.searchgov.suggestions == true %}
    <script>
          var usasearch_config = { siteHandle: "{{ site.searchgov.affiliate }}" };
    </script>
    <script async src="https://search.usa.gov/javascripts/remote.loader.js" type="text/javascript"></script>
  {% endif %}
{% endif %}

<!-- Custom subnav toggle -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const toggle = document.querySelector('.usa-subnav-mobile-toggle');
      if (toggle) {
          toggle.addEventListener('click', function() {
              toggle.classList.toggle('open-subnav');
          });
      }

      if (window.innerWidth < 1024) {
          const sidenavItems = document.querySelectorAll('li.usa-sidenav__item');
          sidenavItems.forEach(function(item) {
              if (item.querySelector('ul')) {
                  item.classList.add('toggle-submenu');
              }
          });
      }

      const subtoggle = document.querySelectorAll('.toggle-submenu');
      subtoggle.forEach(function(toggle) {
          toggle.addEventListener('click', function() {
              toggle.classList.toggle('open-subnav');
          });
      });
  });
</script>

<!-- Conditionally hide past info sessions -->
<script>
  const now = new Date();
  const currentTimestamp = Math.floor(new Date(now).getTime() / 1000);

  function formatDate(date) {
    const year = date.getFullYear(); // Get the four-digit year
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Get the month (0-11) and add 1; pad with 0 if needed
    const day = String(date.getDate()).padStart(2, '0'); // Get the day of the month; pad with 0 if needed

    return `${year}-${month}-${day}`; // Format as 'yyyy-mm-dd'
  }

  const path = window.location.pathname;
  const pathSegments = path.split('/');
  const lastPathItem = pathSegments.filter(segment => segment !== '').pop();

  if ( lastPathItem === 'join' ) {
    const allJobs = [];

    {% for job in collections.jobs %}
      allJobs.push({
        title: "{{ job.data.title }}",
        url: "{{ job.url }}",
        external_url: "{{ pg.data.external_url }}",
        opens: "{{ job.data.opens | htmlDateString }}",
        closes: "{{ job.data.closes | htmlDateString }}",
        info_sessions: "{{ job.data.info_sessions }}"
      });
    {% endfor %}

    sortJobs(allJobs);
  }

  function sortJobs(allJobs) {
    const openJobs = [];
    const upcomingJobs = [];
    const today = formatDate(now);
    
    allJobs.forEach(job => {
      const opens = job.opens !== '' ? job.opens : '';

      const closes = job.closes !== ''  ? job.closes : '';


      // If there is an opens date and;
      // If today is after or equal to the opens date and before the closes date, add the job to the openJobs array.
      // Also add it if today is after or equal to the opens date and there is no close date.
      if ( opens !== '' && ( ( today >= opens && closes > today ) || ( today >= opens && closes === '' ) ) ) {
        
        // Make sure it doesn't push the base index page.
        if ( job.title !== '' ) {
          openJobs.push(job);
        } 
      }

      // If today is before the opens date and before the closes date, add the job to the upcomingJobs array.
      // Also add it if no dates are added to the opens and closes fields
      // Also add it if today is before the opens date and there is no close date
      if ( ( opens > today && closes > today ) || ( opens === '' && closes === '' ) || opens > today && closes > today ) {
        // Make sure it doesn't push the base index page.
        if ( job.title !== '' ) {
          upcomingJobs.push(job);
        } 
      }
    });

    addOpenJobsToDOM(openJobs);
    addUpcomingJobsToDOM(upcomingJobs);
  }

  function addOpenJobsToDOM(openJobs) {
    const openJobsSection = document.querySelector('.open-jobs');
    const jobList = document.createElement('ul');

    jobList.style.paddingLeft = '3ch';

    if ( openJobs.length > 0 ) {
      openJobs.forEach(job => {
        const listItem = document.createElement('li'); 
        const link = document.createElement('a');

        listItem.style.marginBottom = '0.25em';
        link.style.color = '#005ea2';

        // Set the link URL
        const linkUrl = job.external_url !== '' ? job.external_url : job.url;
        link.href = linkUrl;

        // Set the target attribute for external links to open in a new window
        if (job.external_url !== '') {
            link.target = '_blank'; // Open in a new window
        }

        // Set the text content to the job title
        link.textContent = job.title; 
        
        // Append the link to the list item, and the list item to the list
        listItem.appendChild(link);
        jobList.appendChild(listItem);
      });

      openJobsSection.appendChild(jobList);
    } else {
      const noJobsText = document.createElement('p');
      noJobsText.innerHTML = 'No open positions at this time. Sign up for <a href="/join/newsletter/">job alerts!</a>';
      
      openJobsSection.appendChild(noJobsText);
    }
    
  }

  function addUpcomingJobsToDOM(upcomingJobs) {
    const upcomingJobsSection = document.querySelector('.upcoming-jobs');
    const jobList = document.createElement('ul');

    jobList.style.paddingLeft = '3ch';

    if ( upcomingJobs.length > 0 ) {
      upcomingJobs.forEach(job => {
        const listItem = document.createElement('li'); 
        const link = document.createElement('a');

        listItem.style.marginBottom = '0.25em';
        link.style.color = '#005ea2';

        // Set the link URL
        const linkUrl = job.external_url !== '' ? job.external_url : job.url;
        link.href = linkUrl;

        // Set the target attribute for external links to open in a new window
        if (job.external_url !== '') {
            link.target = '_blank'; // Open in a new window
        }

        // Set the text content to the job title
        link.textContent = job.title; 
        
        // Append the link to the list item, and the list item to the list
        listItem.appendChild(link);
        jobList.appendChild(listItem);
    });

    upcomingJobsSection.appendChild(jobList);

    } else {
      const noJobsText = document.createElement('p');
      noJobsText.innerHTML = 'No upcoming positions at this time. Sign up for <a href="/join/newsletter/">job alerts!</a>';
      
      openJobsSection.appendChild(noJobsText);
    }

  }


  function hidePastInfoSessions(currentTimestamp) {
    const infoSessionsGroup = document.querySelectorAll(".info-sessions-list");

    infoSessionsGroup.forEach(sessionGroup => {
      let visibleSessions = 0;

      // Convert sessionGroup.children to an array and loop over them
      Array.from(sessionGroup.children).forEach(session => {
        const session_timestamp = session.getAttribute('data-session-end-timestamp');

        // Hide past sessions
        if (session_timestamp < currentTimestamp) {
          session.style.display = 'none'; // Hide past session
        } else {
          visibleSessions++; // Count future session
        }
      });

      if (visibleSessions === 0) {
        const asideParent = sessionGroup.closest('aside');
        if (asideParent) {
          asideParent.style.display = 'none';
        }
      }
    });
  }
  hidePastInfoSessions(currentTimestamp);
</script>
